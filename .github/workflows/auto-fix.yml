name: Auto Fix CI

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

jobs:
  auto-fix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Run lint
        id: lint
        run: |
          if npm run lint 2>&1; then
            echo "lint_passed=true" >> $GITHUB_OUTPUT
          else
            echo "lint_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run build
        id: build
        run: |
          if npm run build 2>&1; then
            echo "build_passed=true" >> $GITHUB_OUTPUT
          else
            echo "build_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        id: test
        run: |
          if npm test 2>&1; then
            echo "test_passed=true" >> $GITHUB_OUTPUT
          else
            echo "test_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create fix branch
        if: ${{ steps.lint.outputs.lint_passed == 'false' || steps.build.outputs.build_passed == 'false' || steps.test.outputs.test_passed == 'false' }}
        run: |
          BRANCH_NAME="fix/ci-auto-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "needs_fix=true" >> $GITHUB_ENV

      - name: Add CHANGELOG
        if: ${{ env.needs_fix == 'true' }}
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          echo "## [Unreleased]" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Fixed" >> CHANGELOG.md
          echo "- 自动修复 CI 构建问题 ($(date +%Y-%m-%d))" >> CHANGELOG.md

      - name: Commit and push
        if: ${{ env.needs_fix == 'true' }}
        run: |
          git add -A
          git commit -m "fix: 自动修复 CI 构建问题" || true
          git push -u origin ${{ env.BRANCH_NAME }}
        continue-on-error: true

      - name: Create PR
        if: ${{ env.needs_fix == 'true' }}
        run_fix == 'true: |
          gh pr create \
            --title "fix: 自动修复 CI 构建问题" \
            --body "## 自动修复\n\nCI 检测到以下问题并尝试自动修复：\n\n- Lint: ${{ steps.lint.outputs.lint_passed }}\n- Build: ${{ steps.build.outputs.build_passed }}\n- Test: ${{ steps.test.outputs.test_passed }}\n\n请检查修复是否正确。" \
            --base main \
            --head ${{ env.BRANCH_NAME }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto merge PR
        if: ${{ env.needs_fix == 'true' }}
        run: |
          sleep 5
          PR_NUMBER=$(gh pr list --head ${{ env.BRANCH_NAME }} --json number -q '.[0].number')
          gh pr merge $PR_NUMBER --auto --squash || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
